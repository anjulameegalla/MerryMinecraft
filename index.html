<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Merry Mine-Craft</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÖ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0f1626; 
            --grass-top: #f0f8ff; 
            --grass-side: #2d5a27; 
            --dirt: #5d4037; 
            --stone: #757575;
            --ui-bg: #c6c6c6;
            --ui-border-light: #ffffff;
            --ui-border-dark: #555555;
            --text-color: #3f3f3f;
            --accent: #c62828; 
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            font-family: 'VT323', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            color: white;
            touch-action: none; 
            overflow: hidden;
            will-change: background-position;
            animation: snow 20s linear infinite;
        }

        @keyframes snow {
            0% { background-position: 0 0, 40px 60px, 130px 270px; }
            100% { background-position: 550px 550px, 390px 410px, 380px 520px; }
        }

        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            gap: 10px;
            padding: 10px;
            box-sizing: border-box;
        }

        #sidebar {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-size: clamp(2rem, 4vw, 3.5rem);
            color: #ff5252;
            text-shadow: 4px 4px 0 #fff;
            letter-spacing: 2px;
            line-height: 0.9;
        }

        .subtitle {
            color: #81c784;
            font-size: 1.3rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 0 #000;
        }

        .mc-panel {
            background: var(--ui-bg);
            border: 4px solid;
            border-color: var(--ui-border-light) var(--ui-border-dark) var(--ui-border-dark) var(--ui-border-light);
            padding: 5px 15px;
            color: var(--text-color);
            font-size: 1.5rem;
            display: flex;
            gap: 20px;
            align-items: center;
            box-shadow: 0 8px 0 rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        .hearts {
            color: #d32f2f;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 2px;
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0;
            background: #111;
            padding: 4px;
            border: 4px solid #fff;
            box-shadow: 0 0 20px #c62828;
            image-rendering: pixelated;
            height: 60vh; 
            aspect-ratio: 7/10;
            max-width: 95vw;
        }

        @media (min-width: 800px) and (min-height: 500px) {
            #game-container {
                flex-direction: row;
                justify-content: center;
                gap: 50px;
            }
            #sidebar {
                align-items: flex-end;
                text-align: right;
            }
            h1 {
                font-size: 5rem;
                margin-bottom: 20px;
            }
            #grid {
                height: 85vh;
            }
        }

        .cell {
            width: 100%;
            height: 100%;
            background-color: var(--grass-top);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(12px, 2.5vh, 28px);
            user-select: none;
            position: relative;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: inset -4px -4px 0 rgba(0,0,0,0.15), inset 4px 4px 0 rgba(255,255,255,0.8);
            overflow: hidden;
        }

        .cell.closed:hover {
            filter: brightness(0.95);
        }

        .cell.revealed {
            background-color: var(--dirt);
            box-shadow: inset 3px 3px 0 rgba(0,0,0,0.3);
            color: white;
            text-shadow: 2px 2px 0 #000;
        }

        .cell.revealed.empty {
            opacity: 0.95;
        }
        
        .num-1 { color: #5555FF; }
        .num-2 { color: #55FF55; }
        .num-3 { color: #FF5555; }
        .num-4 { color: #5555FF; }
        .num-5 { color: #FF5555; }

        .cell.bomb {
            background-color: #d32f2f;
            animation: explode 0.4s;
        }

        .cell.flagged::after {
            content: 'üö©';
            font-size: 80%; 
            filter: drop-shadow(2px 2px 0 rgba(255,255,255,0.5));
        }

        #mobile-controls {
            position: fixed;
            bottom: 10px;
            display: flex;
            gap: 15px;
            z-index: 50;
            width: 100%;
            justify-content: center;
            pointer-events: none;
        }

        .tool-btn {
            pointer-events: auto;
            width: 70px;
            height: 70px;
            background: var(--ui-bg);
            border: 4px solid;
            border-color: var(--ui-border-light) var(--ui-border-dark) var(--ui-border-dark) var(--ui-border-light);
            font-family: 'VT323', monospace;
            font-size: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }

        .tool-btn:active {
            transform: translateY(4px);
            box-shadow: none;
            border-color: var(--ui-border-dark) var(--ui-border-light) var(--ui-border-light) var(--ui-border-dark);
        }

        .tool-btn.selected {
            background: #81c784;
            border-color: var(--ui-border-dark) var(--ui-border-light) var(--ui-border-light) var(--ui-border-dark);
            transform: scale(0.95);
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
        }
        
        #mute-btn {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            position: fixed;
            top: 20px;
            right: 20px;
            pointer-events: auto;
        }

        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s;
        }
        
        .hidden { display: none; }

        .mc-btn {
            background: #757575;
            color: white;
            border: 4px solid;
            border-color: #fff #333 #333 #fff;
            padding: 15px 40px;
            font-size: 1.8rem;
            font-family: 'VT323', monospace;
            cursor: pointer;
            text-shadow: 2px 2px 0 #000;
            margin-top: 20px;
            width: 280px;
            transition: background 0.2s;
        }
        .mc-btn:hover { background: #888; }
        .mc-btn:active {
            border-color: #333 #fff #fff #333;
        }
        
        .mc-btn.green { background: #2e7d32; }
        .mc-btn.green:hover { background: #388e3c; }

        .instructions-list {
            list-style: none;
            padding: 0;
            text-align: left;
            font-size: 1.2rem;
            color: #333;
        }
        .instructions-list li { margin-bottom: 5px; }

        @keyframes explode {
            0% { background: #fff; transform: scale(1.2); }
            50% { background: #ffeb3b; transform: scale(1.1) rotate(5deg); }
            100% { background: #d32f2f; transform: scale(1) rotate(0deg); }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(3px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-5px, 0, 0); }
            40%, 60% { transform: translate3d(5px, 0, 0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <audio id="bg-music" loop preload="auto" src="assets/SnowyNights.mp3"></audio>

    <div id="game-container">
        <div id="sidebar">
            <h1>MERRY<br>MINE-CRAFT</h1>
            <div class="subtitle">Holiday Edition</div>
            <div class="mc-panel">
                <div>‚ù§Ô∏è <span id="health-display" class="hearts">3/3</span></div>
                <div>üéÅ <span id="score-display">0</span></div>
            </div>
        </div>
        <div id="grid"></div>
    </div>

    <div id="mobile-controls">
        <button id="btn-dig" class="tool-btn selected" onclick="setMode('dig')">‚õèÔ∏è</button>
        <button id="btn-flag" class="tool-btn" onclick="setMode('flag')">üö©</button>
    </div>
    
    <button id="mute-btn" class="tool-btn" onclick="toggleMusic()">üîä</button>

    <div id="instructions-modal" class="modal">
        <h1 style="color: #55ff55; font-size: 2.5rem; margin:0 0 10px 0;">HOW TO PLAY</h1>
        <div class="mc-panel" style="flex-direction: column; width: 85%; max-width: 350px;">
            <ul class="instructions-list">
                <li>‚õèÔ∏è <b>DIG</b> snow blocks to find GIFTS üéÅ</li>
                <li>‚ù§Ô∏è You have <b>3 HEARTS</b>.</li>
                <li>üß® <b>TNTs</b> [10] hurt you! Avoid them!</li>
                <li>üö© Use <b>FLAGS</b> to mark TNT.</li>
                <li>üî¢ <b>Numbers</b> show TNTs nearby.</li>
            </ul>
        </div>
        <button class="mc-btn green" onclick="startGame()">START GAME</button>
    </div>

    <div id="game-over-modal" class="modal hidden">
        <h1 style="color: #ff5555; font-size: 4rem;">FROST BITE!</h1>
        <p style="font-size: 2rem; color: white; text-shadow: 2px 2px #000; margin: 0;">Score: <span id="final-score-loss">0</span></p>
        <button class="mc-btn" onclick="resetGame()">TRY AGAIN</button>
    </div>

    <div id="win-modal" class="modal hidden">
        <h1 style="color: #55ff55; font-size: 4rem;">SANTA PROUD!</h1>
        <p style="font-size: 2rem; color: white; text-shadow: 2px 2px #000; margin: 0;">Gifts: <span id="final-score-win">0</span></p>
        <button class="mc-btn green" onclick="resetGame()">NEXT LEVEL</button>
    </div>

    <script>
        const MusicSys = {
            ctx: null,
            muted: false,
            useMp3: false,
            audioElement: document.getElementById('bg-music'),
            
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();

                this.audioElement.addEventListener('error', (e) => {
                    console.log("MP3 failed to load/find. Check assets folder.");
                    this.useMp3 = false;
                });

                // GitHub Pages Case Sensitivity Check
                if (this.audioElement.src) {
                    this.useMp3 = true;
                }
            },

            start: function() {
                if(this.ctx && this.ctx.state === 'suspended') this.ctx.resume();

                if(this.useMp3 && !this.muted) {
                     const playPromise = this.audioElement.play();
                     if (playPromise !== undefined) {
                         playPromise.catch(error => {
                             console.log("Auto-play prevented by browser policy.");
                         });
                     }
                }
            },

            stop: function() {
                if(this.useMp3) {
                    this.audioElement.pause();
                    this.audioElement.currentTime = 0;
                }
            },

            toggleMute: function() {
                this.muted = !this.muted;
                const btn = document.getElementById('mute-btn');
                btn.innerText = this.muted ? 'üîá' : 'üîä';
                
                if(this.muted) {
                     if(this.useMp3) this.audioElement.pause();
                } else {
                    if(this.useMp3) this.audioElement.play().catch(e=>console.log(e));
                }
            },

            // SFX
            playDig: function() {
                if(this.muted || !this.ctx) return;
                const bufferSize = this.ctx.sampleRate * 0.1;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 1000;
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.ctx.destination);
                noise.start();
            },

            playFlag: function() {
                if(this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, this.ctx.currentTime + 0.05);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, this.ctx.currentTime + 0.05);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.05);
            },

            playExplode: function() {
                if(this.muted || !this.ctx) return;
                const bufferSize = this.ctx.sampleRate * 0.5;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(800, this.ctx.currentTime);
                filter.frequency.linearRampToValueAtTime(100, this.ctx.currentTime + 0.4);
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0.5, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.4);
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.ctx.destination);
                noise.start();
            },

            playPresent: function() {
                if(this.muted || !this.ctx) return;
                const now = this.ctx.currentTime;
                [523.25, 659.25, 783.99].forEach((freq, i) => {
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0, now + i*0.05);
                    gain.gain.linearRampToValueAtTime(0.1, now + i*0.05 + 0.05);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.05 + 0.5);
                    osc.connect(gain);
                    gain.connect(this.ctx.destination);
                    osc.start(now + i*0.05);
                    osc.stop(now + i*0.05 + 0.6);
                });
            },

            playItem: function() {
                if(this.muted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(600, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.1);
            }
        };

        const ROWS = 10;
        const COLS = 7;
        const BOMBS = 10;
        
        let grid = [];
        let gameOver = false;
        let hearts = 3;
        let score = 0;
        let currentMode = 'dig';

        const gridElement = document.getElementById('grid');
        const healthElement = document.getElementById('health-display');
        const scoreElement = document.getElementById('score-display');
        const gameOverModal = document.getElementById('game-over-modal');
        const winModal = document.getElementById('win-modal');
        const instructionsModal = document.getElementById('instructions-modal');

        const ITEMS = ['üéÅ', 'üç™', 'ü•õ', 'üç¨', 'üß∏']; 
        const BOMB_ICON = 'üß®'; 
        const EXPLODE_ICON = 'üí•';

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-dig').classList.toggle('selected', mode === 'dig');
            document.getElementById('btn-flag').classList.toggle('selected', mode === 'flag');
        }

        function toggleMusic() {
            MusicSys.toggleMute();
        }

        function updateUI() {
            let heartStr = '';
            for(let i=0; i<hearts; i++) heartStr += '‚ù§Ô∏è';
            healthElement.innerHTML = heartStr;
            scoreElement.innerText = score;
        }

        function startGame() {
            instructionsModal.classList.add('hidden');
            MusicSys.init(); 
            MusicSys.start();
            initGame();
        }
        
        function resetGame() {
            initGame();
        }

        function initGame() {
            grid = [];
            gameOver = false;
            hearts = 3;
            score = 0;
            currentMode = 'dig';
            updateUI();
            setMode('dig');
            gameOverModal.classList.add('hidden');
            winModal.classList.add('hidden');
            gridElement.innerHTML = '';
            
            for(let r=0; r<ROWS; r++) {
                const row = [];
                for(let c=0; c<COLS; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell', 'closed');
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    cell.addEventListener('click', () => handleInput(r, c));
                    gridElement.appendChild(cell);
                    
                    let item = '';
                    if (Math.random() > 0.85) item = 'üéÅ'; 
                    else if (Math.random() > 0.9) item = ITEMS[Math.floor(Math.random() * ITEMS.length)];

                    row.push({
                        element: cell,
                        isBomb: false,
                        revealed: false,
                        flagged: false,
                        neighborBombs: 0,
                        item: item
                    });
                }
                grid.push(row);
            }

            let placedBombs = 0;
            while(placedBombs < BOMBS) {
                const r = Math.floor(Math.random() * ROWS);
                const c = Math.floor(Math.random() * COLS);
                if(!grid[r][c].isBomb) {
                    grid[r][c].isBomb = true;
                    grid[r][c].item = ''; 
                    placedBombs++;
                }
            }

            for(let r=0; r<ROWS; r++) {
                for(let c=0; c<COLS; c++) {
                    if(grid[r][c].isBomb) continue;
                    let count = 0;
                    getNeighbors(r, c).forEach(n => {
                        if(grid[n.r][n.c].isBomb) count++;
                    });
                    grid[r][c].neighborBombs = count;
                }
            }
        }

        function getNeighbors(r, c) {
            const neighbors = [];
            for(let i=-1; i<=1; i++) {
                for(let j=-1; j<=1; j++) {
                    if(i===0 && j===0) continue;
                    const nr = r+i;
                    const nc = c+j;
                    if(nr>=0 && nr<ROWS && nc>=0 && nc<COLS) {
                        neighbors.push({r: nr, c: nc});
                    }
                }
            }
            return neighbors;
        }

        function handleInput(r, c) {
            if(gameOver) return;
            if(currentMode === 'flag') {
                toggleFlag(r, c);
            } else {
                if(grid[r][c].flagged) return; 
                reveal(r, c);
            }
        }

        function toggleFlag(r, c) {
            if(grid[r][c].revealed) return;
            MusicSys.playFlag();
            const cell = grid[r][c];
            cell.flagged = !cell.flagged;
            cell.element.classList.toggle('flagged');
        }

        function reveal(r, c) {
            const cell = grid[r][c];
            if(cell.revealed || cell.flagged) return;

            cell.revealed = true;
            cell.element.classList.remove('closed');
            cell.element.classList.add('revealed');

            if(cell.isBomb) {
                MusicSys.playExplode();
                cell.element.classList.add('bomb');
                cell.element.innerText = EXPLODE_ICON;
                document.body.classList.add('shake');
                setTimeout(() => document.body.classList.remove('shake'), 500);
                hearts--;
                updateUI();
                if(hearts <= 0) handleGameOver();
            } else {
                MusicSys.playDig();
                if(cell.neighborBombs > 0) {
                    cell.element.innerText = cell.neighborBombs;
                    cell.element.classList.add(`num-${cell.neighborBombs}`);
                    if(cell.item === 'üéÅ') {
                        score += 50;
                        MusicSys.playPresent();
                    }
                } else {
                    if(cell.item) {
                        cell.element.innerText = cell.item;
                        if(cell.item === 'üéÅ') {
                            score += 100;
                            MusicSys.playPresent();
                        } else {
                            score += 10;
                            MusicSys.playItem();
                        }
                    } else {
                        cell.element.classList.add('empty');
                    }
                    if(cell.neighborBombs === 0 && !cell.item) {
                         getNeighbors(r, c).forEach(n => reveal(n.r, n.c));
                    }
                }
                updateUI();
                checkWin();
            }
        }

        function handleGameOver() {
            gameOver = true;
            document.getElementById('final-score-loss').innerText = score;
            grid.forEach(row => row.forEach(cell => {
                if(cell.isBomb) {
                    cell.element.classList.remove('closed');
                    cell.element.classList.add('bomb');
                    cell.element.innerText = BOMB_ICON;
                }
            }));
            setTimeout(() => {
                gameOverModal.classList.remove('hidden');
            }, 500);
        }

        function checkWin() {
            if(gameOver) return;
            let unrevealedSafe = 0;
            grid.forEach(row => row.forEach(cell => {
                if(!cell.isBomb && !cell.revealed) unrevealedSafe++;
            }));

            if(unrevealedSafe === 0) {
                gameOver = true;
                score += (hearts * 200); 
                document.getElementById('final-score-win').innerText = score;
                setTimeout(() => {
                    winModal.classList.remove('hidden');
                }, 300);
            }
        }
    </script>
</body>
</html>